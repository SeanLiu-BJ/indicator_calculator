# 技术架构（离线桌面 B/S）

## 1. 目标形态

- 离线桌面应用体验：双击启动 → 自动打开“应用窗口”
- 应用内部采用本地 B/S：启动本地服务（仅监听 `127.0.0.1`）→ Electron 窗口加载 `http://127.0.0.1:<port>`
- 关闭应用：前端退出 → Electron 关闭窗口 → 停止本地服务进程

## 2. 技术栈建议（收敛版）

- 桌面壳：Electron
- 本地服务：Python 3 + FastAPI（Uvicorn）
- 前端：React + TypeScript + ECharts
- 本地存储（无远程依赖）：
  - 原始数据：文件存储（CSV 原样/清洗后 CSV）
  - 元数据/映射/权重模型/结果索引：嵌入式文档库（优先 `mongita`）或 JSON 文件（MVP 可先 JSON）
- 数值计算：NumPy（PCA/矩阵运算/AHP 一致性检验）

## 3. 进程与启动方式

### 3.1 Electron 主进程职责

- 选择可用端口（优先固定端口，冲突则自动切换）
- 启动 Python 服务子进程（带上端口、数据目录、访问 token）
- 轮询 `/health`，健康后打开窗口访问 `http://127.0.0.1:<port>`
- 监听应用退出事件，向服务发送优雅关闭信号，必要时强制终止

### 3.2 服务仅本机可用（安全基线）

- FastAPI 绑定 `127.0.0.1`
- Electron 启动时生成随机 `token`，前端请求必须携带 `Authorization: Bearer <token>`
- 禁止对外网卡监听，避免被局域网访问

## 4. 模块划分（建议）

### 4.1 前端模块

- `Dataset`：导入向导、数据集列表/预览/删除、表格编辑
- `Indicator`：指标库维护（含二级指标维度 `dimension2Key`）、正负向设置、别名/模板
- `Mapping`：列映射配置、模板保存/应用、缺失/类型校验
- `WeightModel`：熵权/PCA/AHP 配置、训练、预览、保存版本
- `Compute`：选择权重模型与目标数据集，发起计算，查看指数表格（主产物）
- `Chart`：ECharts 折线图、对比、导出（含图片导出，可选）
  - 支持按“综合指数 / 二级分项指数（dimension2）”切换展示

### 4.2 后端模块（FastAPI）

- 导入/解析：CSV 文件与文本解析、类型推断、重复键检查
- 存储：数据集文件管理 + 元数据/映射/模型/结果管理
- 算法：熵权/PCA/AHP 权重计算、标准化、指数计算

## 5. 数据与存储设计（建议字段）

### 5.1 文件结构（示例）

应用数据目录（Electron `app.getPath("userData")`）：

```
indicator_calculator/
  datasets/
    <datasetId>/
      data.csv
      schema.json
  models/
    weight_models.json
  results/
    <resultId>.csv
  metadata.json
```

### 5.2 核心实体（逻辑）

- `Dataset`
  - `id`, `name`, `createdAt`, `sourceType`(file/paste/manual)
  - `schema`: 列名、类型推断、主键（`entity`,`year`）
- `Indicator`
  - `key`, `name`, `dimension2Key`, `direction`, `unit?`, `aliases?`
- `Mapping`
  - `datasetId`, `map: { indicatorKey -> columnName }`
  - `templateName?`
- `WeightModel`
  - `id`, `name`, `method`(entropy/pca/ahp)
  - `indicatorKeys[]`, `weights{key->w}`
  - `dimension2Weights?{dimension2Key->W_g}`（由 `weights` 汇总得到，用于分项输出/解释）
  - `standardization`(minmax/zscore) + 训练参数（min/max 或 mean/std）
  - `trainedOnDatasetIds[]`（熵权/PCA），`ahpMatrix?`（AHP）
- `ResultSet`
  - `id`, `name`, `weightModelId`, `datasetIds[]`, `createdAt`
  - 输出表（至少包含 `entity,year,score_raw,index_0_100`，以及按 `dimension2Key` 的分项指数列）

## 6. API 轮廓（MVP）

仅列关键接口（具体入参/出参后续在实现阶段细化）：

- `GET /health`
- `POST /datasets/import`（文件/文本）
- `GET /datasets` / `GET /datasets/{id}`
- `PUT /datasets/{id}/data`（表格编辑保存）
- `GET /indicators` / `POST /indicators`
- `PUT /mappings/{datasetId}`
- `POST /weight-models/train`（entropy/pca）
- `POST /weight-models/ahp`（提交判断矩阵→生成模型）
- `POST /compute`（选择模型+数据集→生成结果集）
- `GET /results` / `GET /results/{id}` / `GET /results/{id}/chart`

## 7. 打包与发布（建议）

- Python 服务：PyInstaller 打成可执行文件随 Electron 分发（避免用户本机装 Python）
- Electron：`electron-builder` 生成 Win/Mac 安装包
- 跨平台构建建议：使用 CI（Windows runner 产出 Windows 包；macOS runner 产出 mac 包）
