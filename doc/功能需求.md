# 功能需求（MVP）

## 1. 目标与范围

目标：构建一套**离线桌面应用**，用户可导入（或手工编辑）年度数据，配置指标映射，选择预设权重算法（≥3），计算每个组织在每个年度的综合指数，并通过 ECharts 展示。

范围（MVP）：
- 数据粒度：**年度**（每行代表一个 `entity-year` 观测）
- 输出粒度：**每个 entity × year 输出综合指数 + 二级分项指数**
- 权重算法：熵权法、PCA 近似、层次分析法（AHP）
- 离线：不依赖远程服务；应用启动即可使用
- 首次使用引导：内置一份已导入的 sample data，支持三种算法一键切换计算并查看表格/图表差异

非目标（MVP 不做）：
- 账号体系、多人协作、远程同步
- 复杂统计检验/严格 EFA 因子分析（采用 PCA 近似）
- 高级缺失值插补（先做缺失提示与阻断计算）
- 导入时按列切分（split）为多个独立数据集（后续增强）

## 2. 核心概念

- **数据集（Dataset）**：一次导入/编辑后形成的可复用数据集合，可包含多个实体、多年数据。
- **指标（Indicator）**：可参与指数计算的字段，具有 `key`（公式变量名）、方向（正向/负向）、标准化策略默认值等属性。
- **二级指标维度（Dimension2）**：对指标进行分组的“维度/主题”（如 经营规模/盈利能力/偿债能力），用于输出二级分项指数。
- **实体（Entity）**：指数计算的对象（抽象主体），可表示公司/机构/组织/产品线等；CSV 里用 `entity` 列标识。
- **指数（Index）**：对每条 `entity-year` 样本计算得到的综合结果（如 `score_raw`、`index_0_100`），用于跨实体/跨年对比与展示。
- **指数表格（Index Table）**：指数计算的主要产物，以表格形式呈现与导出；用户可只查看指数表格而不查看图表。
- **示例数据（Sample Data）**：应用内置的一份已导入数据集与指标配置，用于首次使用快速理解算法差异。
- **列映射（Mapping）**：将某数据集的“原始列”映射到指标 `key`（解决不同来源字段名不同的问题）。
- **权重模型（Weight Model）**：由某种算法得到的一组指标权重 `w`（可保存、复用、版本化）。
- **指数计算任务（Compute Job）**：选择“权重模型 + 目标数据集”计算并产出指数表格（主）与可选图表数据。

## 3. 数据输入与预期格式

### 3.1 导入方式

- CSV 文件导入
- 复制粘贴 CSV 文本导入
- GUI 表格手动编辑（用于小规模修正/补录）

### 3.2 CSV 基本结构（建议）

必须列：
- `entity`：实体标识（公司/机构/组织/主体等）
- `year`：年份（如 `2022`）

可选列：
- 任意指标列：如 `production`、`sales`、`profit` 等
- 任意维度列：如 `industry`、`region`、`source` 等（可用于筛选/分组）

示例表头：

```csv
entity,year,industry,production,sales,profit_margin
```

约束（MVP）：
- `year` 必须存在；若导入数据缺 `year`，在导入向导中由用户输入固定年份并补列（仅适用于单年文件）
- `entity + year` 在同一数据集中应唯一；如重复需在导入/编辑阶段提示并要求合并或删除

## 4. 指标与映射

### 4.1 指标库

用户可维护“指标库”，每个指标至少包括：
- `key`：唯一标识（如 `production`）
- `name`：显示名称
- `dimension2Key`：二级指标维度 key（用于分项指数输出）
- `direction`：正向（值越大越好）/负向（值越小越好）
- `unit`（可选）

### 4.2 数据列映射到指标 key

每个数据集需要维护映射关系：
- 将数据集的原始列（如 `prod_ton`）映射到指标 `key`（如 `production`）
- 支持“自动匹配（同名/别名）+ 手工调整”
- 支持保存/应用“映射模板”（同一数据来源重复导入时直接复用）

校验规则（MVP）：
- 计算时若权重模型所需的某个 `key` 在目标数据集中缺失，则阻断并提示缺失项
- 若存在非数值、空值、或全列常数导致标准差为 0，则提示并要求修正或剔除指标

## 5. 权重算法（预设 ≥3）

三种方法均输出一组权重 `w`（各指标权重非负、和为 1）：
- **熵权法**：标准化默认 `min-max`
- **PCA 近似**：标准化默认 `z-score`
- **AHP**：权重来自判断矩阵（含一致性检验），数据标准化默认 `z-score`

权重模型支持保存与复用：
- 可用“历史数据集（跨年）”训练权重（熵权/PCA）
- 训练完成保存为权重模型，后续对任意年度/数据集直接 apply

## 6. 指数计算与输出

### 6.1 计算口径（MVP）

- 对每条 `entity-year` 样本：
  - 按算法默认标准化策略得到标准化指标 `x'`
  - 指数得分：`score = Σ(w_j * x'_j)`

为便于展示，系统可提供两种输出：
- `score_raw`：原始加权和（PCA/AHP 可能为负）
- `index_0_100`：将 `score_raw` 线性缩放到 `0-100` 的展示值（缩放参考范围可选“训练集”或“当前计算集”，默认用训练集以保持可比性）

### 6.2 指数表格（主产物）

结果页默认提供“指数表格”，无需打开图表也可完成查看与导出：
- 主表字段：`entity, year, index_0_100, score_raw`
- 二级分项字段：按 `dimension2Key` 输出分项指数列（如 `subindex.<dimension2Key>_0_100`），用于分析“哪类能力”驱动变化
- 可选字段：各指标标准化值、权重、指标贡献度（用于解释性分析）
- 交互：筛选/排序/搜索、按实体或年份聚合查看、导出 CSV

### 6.3 结果管理

- 计算结果保存为“结果集”，可复用/对比
- 支持导出 CSV

## 7. 图表（ECharts，可选）

至少支持：
- 折线图：选择一个或多个 `entity`，X 轴 `year`，Y 轴可选“综合指数 / 二级分项指数”
- 图片导出：将当前图表导出为图片（默认 PNG，可选 SVG）

## 8. 典型使用流程

### 8.1 首次使用（从 sample data 理解算法差异）

1) 打开应用 → 进入“快速开始 / 示例数据”  
2) 基于内置 sample data，在算法选择中切换：熵权 / PCA / AHP  
3) 每次切换后自动计算（或加载预置结果），查看指数表格与二级分项指数差异  
4) 可选查看图表（综合/分项）并导出图片  
5) 点击“开始导入我的数据”进入业务流程

### 8.2 业务使用（导入自有数据）

1) 导入 CSV（文件/粘贴）→ 生成数据集  
2) 维护指标库（或从模板导入，含 `dimension2Key`）  
3) 对数据集配置“列映射 → 指标 key”并校验  
4) 选择权重方法：熵权 / PCA / AHP  
5) 训练并保存权重模型（熵权/PCA 可用历史数据集）  
6) 选择目标数据集计算指数 → 保存结果集  
7) 查看指数表格（可不查看图表）  
8) 选择实体绘制 `year`-指数折线图（可选）  
9) 导出图表图片（用于报告/分享）
