# 功能需求（MVP）

## 1. 目标与范围

目标：构建一套**离线桌面应用**，用户可导入（或手工编辑）年度数据，配置指标映射，选择预设权重算法（≥3），计算每个组织在每个年度的综合指数，并通过 ECharts 展示。

范围（MVP）：
- 数据粒度：**年度**（每行代表一个 `company-year` 观测）
- 输出粒度：**每个 company × year 一个指数值**
- 权重算法：熵权法、PCA 近似、层次分析法（AHP）
- 离线：不依赖远程服务；应用启动即可使用

非目标（MVP 不做）：
- 账号体系、多人协作、远程同步
- 复杂统计检验/严格 EFA 因子分析（采用 PCA 近似）
- 高级缺失值插补（先做缺失提示与阻断计算）

## 2. 核心概念

- **数据集（Dataset）**：一次导入/编辑后形成的可复用数据集合，可包含多个公司、多年数据。
- **Split**：导入时用户选择某一列（如 `industry`/`source`/`region`）将单文件按唯一值切成多个独立数据集并持久化复用。
- **指标（Indicator）**：可参与指数计算的字段，具有 `key`（公式变量名）、方向（正向/负向）、标准化策略默认值等属性。
- **列映射（Mapping）**：将某数据集的“原始列”映射到指标 `key`（解决不同来源字段名不同的问题）。
- **权重模型（Weight Model）**：由某种算法得到的一组指标权重 `w`（可保存、复用、版本化）。
- **指数计算任务（Compute Job）**：选择“权重模型 + 目标数据集”计算并产出结果表与图表数据。

## 3. 数据输入与预期格式

### 3.1 导入方式

- CSV 文件导入
- 复制粘贴 CSV 文本导入
- GUI 表格手动编辑（用于小规模修正/补录）

### 3.2 CSV 基本结构（建议）

必须列：
- `company`：组织标识（公司/机构/主体）
- `year`：年份（如 `2022`）

可选列：
- 任意指标列：如 `production`、`sales`、`profit` 等
- 任意维度列：如 `industry`、`region`、`source` 等（可用于 split 或筛选）

示例表头：

```csv
company,year,industry,production,sales,profit_margin
```

约束（MVP）：
- `year` 必须存在；若导入数据缺 `year`，在导入向导中由用户输入固定年份并补列（仅适用于单年文件）
- `company + year` 在同一数据集中应唯一；如重复需在导入/编辑阶段提示并要求合并或删除

### 3.3 Split（导入切分）

导入向导提供可选步骤：
- 用户选择 `splitByColumn`（任意列）
- 系统按该列唯一值将原始数据切分为多个数据集（如按 `industry` 生成“钢铁/化工/电子”多个数据集）
- 每个子数据集独立保存、可复用、可单独参与训练/计算

## 4. 指标与映射

### 4.1 指标库

用户可维护“指标库”，每个指标至少包括：
- `key`：唯一标识（如 `production`）
- `name`：显示名称
- `direction`：正向（值越大越好）/负向（值越小越好）
- `unit`（可选）

### 4.2 数据列映射到指标 key

每个数据集需要维护映射关系：
- 将数据集的原始列（如 `prod_ton`）映射到指标 `key`（如 `production`）
- 支持“自动匹配（同名/别名）+ 手工调整”
- 支持保存/应用“映射模板”（同一数据来源重复导入时直接复用）

校验规则（MVP）：
- 计算时若权重模型所需的某个 `key` 在目标数据集中缺失，则阻断并提示缺失项
- 若存在非数值、空值、或全列常数导致标准差为 0，则提示并要求修正或剔除指标

## 5. 权重算法（预设 ≥3）

三种方法均输出一组权重 `w`（各指标权重非负、和为 1）：
- **熵权法**：标准化默认 `min-max`
- **PCA 近似**：标准化默认 `z-score`
- **AHP**：权重来自判断矩阵（含一致性检验），数据标准化默认 `z-score`

权重模型支持保存与复用：
- 可用“历史数据集（跨年）”训练权重（熵权/PCA）
- 训练完成保存为权重模型，后续对任意年度/数据集直接 apply

## 6. 指数计算与输出

### 6.1 计算口径（MVP）

- 对每条 `company-year` 样本：
  - 按算法默认标准化策略得到标准化指标 `x'`
  - 指数得分：`score = Σ(w_j * x'_j)`

为便于展示，系统可提供两种输出：
- `score_raw`：原始加权和（PCA/AHP 可能为负）
- `index_0_100`：将 `score_raw` 线性缩放到 `0-100` 的展示值（缩放参考范围可选“训练集”或“当前计算集”，默认用训练集以保持可比性）

### 6.2 结果管理

- 计算结果保存为“结果集”，可复用/对比
- 支持导出 CSV

## 7. 可视化（ECharts）

至少支持：
- 折线图：选择一个或多个 `company`，X 轴 `year`，Y 轴指数（`index_0_100` 或 `score_raw`）
- 表格：按 `company-year` 展示明细（含各指标标准化值、权重、贡献度可选）

## 8. 典型使用流程

1) 导入 CSV（文件/粘贴）→ 可选 split → 生成数据集  
2) 维护指标库（或从模板导入）  
3) 对数据集配置“列映射 → 指标 key”并校验  
4) 选择权重方法：熵权 / PCA / AHP  
5) 训练并保存权重模型（熵权/PCA 可用历史数据集）  
6) 选择目标数据集计算指数 → 保存结果集  
7) 选择公司绘制 `year`-指数折线图（ECharts）

