# 算法口径（熵权 / PCA 近似 / AHP）

## 0. 输入输出约定

### 0.1 输入样本

每条记录为一个样本 `i`：
- 主键：`company`, `year`
- 指标向量：`x_i = (x_{i1}, ..., x_{ip})`（p 个指标）

同一套权重模型的指标集合为 `J = {1..p}`（以 `indicatorKey` 对应）。

### 0.2 二级指标维度（Dimension2）与分项指数

当指标库为每个指标配置了 `dimension2Key` 时：
- 二级维度集合 `G`，每个二级维度 `g ∈ G` 对应一组指标 `J_g ⊆ J`
- 指标权重为 `w_j`，则二级维度权重为：`W_g = Σ_{j∈J_g} w_j`
- 二级分项指数（分项得分）默认用“组内归一权重”计算：
  - `w_{j|g} = w_j / W_g`（当 `W_g > 0`）
  - `sub_score_raw_{i,g} = Σ_{j∈J_g} (w_{j|g} * z_{ij})`
  - 该定义使分项指数更像“该维度内部的综合得分”，与维度整体权重大小解耦
- 维度贡献（可选解释字段）：
  - `contrib_{i,g} = W_g * sub_score_raw_{i,g}`
  - 于是 `score_raw_i = Σ_g contrib_{i,g}`（与综合指数一致）

边界：
- 若某个 `W_g == 0`，该维度无法计算分项指数：提示并在输出中置空/隐藏

### 0.3 指标方向（正/负向）

对负向指标（越小越好），统一先做“同向化”：
- `x' = -x`（或等价的翻转规则），再进入后续标准化流程  
（实现时记录方向，确保熵权与 z-score 口径一致）

### 0.4 指数

标准化后得到 `z_{ij}`，权重为 `w_j`：
- 综合得分：`score_raw_i = Σ_j (w_j * z_{ij})`
- 二级分项得分：`sub_score_raw_{i,g}`（见 0.2）

展示指数（可选）：
- 综合指数：`index_0_100_i = (score_raw_i - a) / (b - a) * 100`
  - 默认 `a,b` 来自训练集 `score_raw` 的 min/max（保持跨年可比）
  - 若目标集出现越界可允许 `<0` 或 `>100`，或提供“截断到 [0,100]”开关
- 分项指数（可选）：对每个维度 `g`，可同样将 `sub_score_raw_{i,g}` 缩放到 `0-100`（默认也用训练集范围以保持可比）

## 1. 标准化

### 1.1 Min-Max（熵权法默认）

对每个指标 j：
- `z_{ij} = (x_{ij} - min_j) / (max_j - min_j)`

边界：
- 若 `max_j == min_j`，该指标无区分度：提示并剔除或权重置 0

### 1.2 Z-Score（PCA/AHP 默认）

对每个指标 j：
- `z_{ij} = (x_{ij} - mean_j) / std_j`

边界：
- 若 `std_j == 0`，同上处理

## 2. 熵权法（Entropy Weight）

### 2.1 适用

基于样本分布的离散程度自动给权重；需要训练集样本矩阵（可跨年）。

### 2.2 步骤（概念）

1) 对训练集做 min-max 得到 `z_{ij}`（均为非负）
2) 计算比例：
   - `p_{ij} = z_{ij} / Σ_i z_{ij}`（若分母为 0，说明全为 0，需剔除）
3) 熵值：
   - `e_j = -k * Σ_i (p_{ij} * ln(p_{ij}))`，`k = 1/ln(n)`
4) 差异系数：
   - `d_j = 1 - e_j`
5) 权重归一：
   - `w_j = d_j / Σ_j d_j`

输出：
- `weights{key->w}`
- `min_j,max_j`（用于 apply 到目标数据集）

## 3. PCA 近似权重（替代因子分析）

### 3.1 适用

采用 PCA 近似因子分析的“降维+综合”思想：通过主成分解释方差贡献得到权重。需要训练集样本量足够（通常 n >> p 更稳）。

### 3.2 步骤（概念）

1) 对训练集做 z-score 得到矩阵 `Z (n×p)`
2) 计算协方差矩阵 `C = cov(Z)`（或相关矩阵）
3) 特征分解得到特征值 `λ_l` 与特征向量 `v_l`
4) 选择前 k 个主成分（默认规则：累计贡献率 ≥ 85%，或用户指定）
5) 计算指标权重（建议口径之一）：
   - 指标 j 在第 l 个主成分的载荷 `a_{jl} = v_{jl} * sqrt(λ_l)`
   - `w_j ∝ Σ_{l=1..k} (a_{jl}^2 * λ_l)`
   - 归一化使 Σ w_j = 1

输出：
- `weights{key->w}`
- `mean_j,std_j`（用于 apply 到目标数据集）
- `k`、累计贡献率（用于解释性展示）

## 4. AHP（层次分析法）

### 4.1 适用

权重由专家判断给出，不依赖训练数据。需要用户输入指标两两比较矩阵。

### 4.2 输入与一致性检验

- 判断矩阵 `A (p×p)`：
  - `a_{jj}=1`
  - `a_{jk} = 1 / a_{kj}`
  - 取值通常为 1–9 标度及其倒数

权重计算（实现可选）：
- 特征向量法：取最大特征值对应特征向量并归一化
- 或几何平均法：`w_j ∝ (Π_k a_{jk})^(1/p)`

一致性：
- `CI = (λ_max - p)/(p-1)`
- `CR = CI / RI[p]`
  - `CR < 0.1` 视为通过；否则提示调整矩阵

输出：
- `weights{key->w}`
- `ahpMatrix`（可保存以便审计）
- `CR`（展示给用户）

### 4.3 指数计算（AHP）

AHP 权重与数据分离：
- apply 到任意目标数据集时，对数据做 z-score（使用“目标集”或“训练集”参数需在产品层定义；MVP 建议使用训练参数以保持可比性）
- `score_raw = Σ(w_j * z_{ij})`
